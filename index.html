<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>予約カレンダー</title>
  <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background-color: #f8f9fa; color: #333; font-family: sans-serif; padding-bottom: 40px; }
    .container { max-width: 600px; background: white; padding: 15px; margin-top: 10px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }

    /* タイトルなどのスタイル */
    h5 { font-weight: bold; color: #333; border-bottom: 1px solid #eee; padding-bottom: 15px; margin-bottom: 20px; text-align: center; }
    label { font-weight: bold; margin-top: 10px; color: #555; font-size: 0.9rem; }
    .required-badge { background-color: #dc3545; color: white; font-size: 0.7rem; padding: 2px 6px; border-radius: 4px; margin-left: 5px; vertical-align: middle; }
    .form-control { font-size: 1rem; }

    /* ★週間カレンダーのスタイル（画像に合わせる）★ */
    .week-nav { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; padding: 0 5px; }
    .current-month { font-size: 1.2rem; font-weight: bold; }

    .table-responsive { overflow-x: auto; -webkit-overflow-scrolling: touch; }
    .calendar-table { width: 100%; min-width: 350px; border-collapse: collapse; table-layout: fixed; }
    
    /* ヘッダー（日付） */
    .calendar-table th { 
        text-align: center; 
        font-size: 0.85rem; 
        padding: 8px 0; 
        border: 1px solid #dee2e6; 
        font-weight: bold;
        background: #fff;
    }
    
    /* 時間セルと中身 */
    .calendar-table td { 
        text-align: center; 
        vertical-align: middle; 
        height: 50px; 
        border: 1px solid #dee2e6; 
        font-size: 1.2rem; 
        cursor: pointer; 
        background: #fff;
    }

    /* 時間列 */
    .time-col {
        font-size: 0.75rem !important;
        font-weight: bold;
        background-color: #f8f9fa !important;
        color: #333;
        width: 50px;
    }

    /* 記号のスタイル */
    .symbol-ok { 
        color: #00B900; 
        font-weight: bold; 
        font-size: 1.4rem;
        display: inline-block;
        border: 2px solid #00B900;
        border-radius: 50%;
        width: 28px;
        height: 28px;
        line-height: 24px;
    } /* 緑の丸 */
    
    .symbol-ng { color: #ccc; font-size: 1.2rem; } /* グレーの× */
    .symbol-rest { color: #ff8888; font-size: 0.9rem; } /* 薄い赤の休 */

    /* 選択されたセル */
    .calendar-table td.selected { background-color: #e6fffa !important; }
    .calendar-table td.selected .symbol-ok { background-color: #00B900; color: white; }

    /* 曜日色 */
    .th-sun { color: #dc3545; }
    .th-sat { color: #007bff; }
    .date-num { font-size: 1.1rem; display: block; }
    .day-label { font-size: 0.7rem; display: block; }

    /* 完了画面 */
    #success-area { display:none; text-align:center; padding-top:50px; }
    .success-icon { font-size: 80px; color: #00B900; margin-bottom: 20px; }
  </style>
</head>
<body>

<div class="container" id="booking-area">
  
  <form id="bookingForm">
    
    <div class="text-center mb-3">
        <small class="text-muted">予約日時を選択してください <span class="badge badge-danger">必須</span></small>
    </div>

    <div class="form-group">
        <select name="menu" id="menuInput" class="form-control" required onchange="renderWeekCalendar()">
          <option value="" data-slots="0">▼メニューを選択（空き状況が表示されます）</option>
          <option value="カット" data-slots="2">カット（約60分）</option>
          <option value="カラー＋カット" data-slots="5">カラー＋カット（約150分）</option>
          <option value="パーマ＋カット" data-slots="5">パーマ＋カット（約150分）</option>
          <option value="トリートメント" data-slots="2">トリートメント（約40分）</option>
          <option value="縮毛矯正＋カット" data-slots="6">縮毛矯正＋カット（約180分）</option>
          <option value="まつ毛パーマ" data-slots="2">まつ毛パーマ（60分）</option>
          <option value="まつげエクステ" data-slots="3">まつげエクステ（90分）</option>
          <option value="着付け" data-slots="2">着付け（約60分）</option>
        </select>
    </div>

    <div class="form-group" id="calendarGroup" style="display:none;">
      
      <div class="week-nav">
        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="prevWeek()">&lt; 前の週</button>
        <span class="current-month" id="currentMonthLabel"></span>
        <button type="button" class="btn btn-sm btn-primary" onclick="nextWeek()">次の週 &gt;</button>
      </div>

      <div class="table-responsive">
        <table class="calendar-table">
          <thead>
            <tr id="dateHeader">
              </tr>
          </thead>
          <tbody id="timeBody">
            </tbody>
        </table>
      </div>
      <div class="text-center mt-2" id="loadingMsg" style="display:none; color:#007bff; font-size:0.9rem;">
        読み込み中...
      </div>
    </div>

    <div id="userInfoArea" style="display:none; margin-top:20px; border-top:1px solid #eee; padding-top:20px;">
        <div class="form-group">
            <label>お名前<span class="required-badge">必須</span></label>
            <input type="text" name="name" class="form-control" placeholder="例：ビューティー 花子" required>
        </div>
        <div class="form-group">
            <label>お問い合わせ</label>
            <textarea name="inquiry" class="form-control" rows="2" placeholder="ご要望など"></textarea>
        </div>
        
        <input type="hidden" name="date" id="selectedDate">
        <input type="hidden" name="time" id="selectedTime">

        <button type="button" id="submitBtn" class="btn btn-success btn-block" onclick="submitData()">予約を確定する</button>
    </div>

  </form>
</div>

<div class="container" id="success-area">
  <div class="success-icon">✔</div>
  <h5>予約を受け付けました</h5>
  <p>ご予約ありがとうございます。<br>確認後、LINEにてご連絡いたします。</p>
  <button onclick="closeLiff()" class="btn btn-secondary mt-4">閉じる</button>
</div>

<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<script>
  // ★★★ ここにGASのURL（/execで終わるやつ）を貼ってください ★★★
  const GAS_API_URL = "https://script.google.com/macros/s/AKfycby7T82gguG2KXD37D0Se-JN7ZgzhW2Rp51bpnQggd8bM41im4VHDDZIgPXxxDUSYg45RA/exec";
  const MY_LIFF_ID = "1657883881-JG16djMv";

  let bookedTimesSet = new Set(); // 予約データを扱いやすくSetで保存
  let currentBaseDate = new Date(); // 表示中の週の基準日

  window.onload = function() {
    // LIFF初期化
    if(typeof liff !== 'undefined'){
      liff.init({ liffId: MY_LIFF_ID }).then(() => {
        if (!liff.isLoggedIn()) liff.login();
      }).catch(err => console.log(err));
    }
    // データ取得開始
    fetchBookedData();
  };

  function fetchBookedData() {
    document.getElementById('loadingMsg').style.display = 'block';
    fetch(GAS_API_URL + '?p=json')
      .then(res => res.json())
      .then(data => {
        // ★重要：データの形式を統一する（0埋めなしに変換して保存）
        bookedTimesSet.clear();
        data.forEach(dt => {
            // dt は "2026/01/31 16:00" または "2026/1/31 16:00" など
            let parts = dt.split(' ');
            if(parts.length === 2) {
                let dParts = parts[0].split('/');
                // 年/月/日 を数値変換して再度結合（これで0埋め問題を解消）
                let normalDate = parseInt(dParts[0]) + '/' + parseInt(dParts[1]) + '/' + parseInt(dParts[2]);
                bookedTimesSet.add(normalDate + ' ' + parts[1]);
            }
        });
        
        document.getElementById('loadingMsg').style.display = 'none';
        renderWeekCalendar();
      })
      .catch(err => {
        console.error("通信エラー", err);
        document.getElementById('loadingMsg').innerText = "通信エラー";
      });
  }

  // 1週間のカレンダーを描画
  function renderWeekCalendar() {
    const menuSelect = document.getElementById('menuInput');
    const slots = parseInt(menuSelect.options[menuSelect.selectedIndex].getAttribute('data-slots') || 0);

    // メニュー未選択ならカレンダーを出さない
    if (slots === 0) {
      document.getElementById('calendarGroup').style.display = 'none';
      document.getElementById('userInfoArea').style.display = 'none';
      return;
    }
    document.getElementById('calendarGroup').style.display = 'block';

    const headerRow = document.getElementById('dateHeader');
    const timeBody = document.getElementById('timeBody');
    headerRow.innerHTML = '<th style="width: 50px; background:#f8f9fa;">時間</th>';
    timeBody.innerHTML = '';

    // 今週の日曜日にセット
    let tempDate = new Date(currentBaseDate);
    tempDate.setDate(tempDate.getDate() - tempDate.getDay()); // 日曜日に戻す

    const days = ['日', '月', '火', '水', '木', '金', '土'];
    let weekDates = [];

    // ヘッダー（日付）を作る
    for (let i = 0; i < 7; i++) {
      let m = tempDate.getMonth() + 1;
      let d = tempDate.getDate();
      let w = tempDate.getDay();
      
      let thClass = '';
      if (w === 0) thClass = 'th-sun';
      if (w === 6) thClass = 'th-sat';

      // 比較用の日付文字列（0埋めなし： 2026/1/1）
      let dateKey = tempDate.getFullYear() + '/' + m + '/' + d;
      // 表示用の日付
      let displayDate = `${d}`;

      // 定休日判定（月曜 or 第3火曜）
      let isHoliday = false;
      if (w === 1) isHoliday = true; // 毎週月曜
      if (w === 2 && d >= 15 && d <= 21) isHoliday = true; // 第3火曜

      weekDates.push({ dateKey: dateKey, isHoliday: isHoliday, dateObj: new Date(tempDate) });

      // ヘッダーHTML
      let thHtml = `<th class="${thClass}"><span class="date-num">${d}</span><span class="day-label">(${days[w]})</span></th>`;
      headerRow.insertAdjacentHTML('beforeend', thHtml);

      // 月の表示を更新
      if (i === 0) {
        document.getElementById('currentMonthLabel').innerText = `${m}月`;
      }

      tempDate.setDate(tempDate.getDate() + 1);
    }

    // 時間枠を作る (9:00 - 19:00, 30分間隔)
    for (let h = 9; h < 19; h++) {
       for (let m = 0; m < 60; m += 30) {
           let timeStr = h + ":" + (m === 0 ? "00" : "30");
           let tr = document.createElement('tr');
           
           // 左端の時間セル
           tr.innerHTML = `<td class="time-col">${timeStr}</td>`;

           // 7日分ループ
           for (let i = 0; i < 7; i++) {
             let info = weekDates[i];
             let td = document.createElement('td');
             
             // 過去の日時かチェック
             let targetDateTime = new Date(info.dateObj);
             targetDateTime.setHours(h, m, 0, 0);
             let now = new Date();

             if (info.isHoliday) {
               // 定休日
               td.innerHTML = '<span class="symbol-rest">休</span>';
               td.style.backgroundColor = '#fff5f5';
             } else if (targetDateTime < now) {
               // 過去
               td.innerHTML = '<span class="symbol-ng">×</span>';
               td.style.backgroundColor = '#fafafa';
               td.style.color = '#eee';
             } else {
               // 空き状況チェック
               if (isAvailable(info.dateKey, h, m, slots)) {
                 td.innerHTML = '<span class="symbol-ok">◯</span>';
                 td.onclick = function() { selectSlot(this, info.dateKey, timeStr); };
               } else {
                 td.innerHTML = '<span class="symbol-ng">×</span>';
               }
             }
             tr.appendChild(td);
           }
           timeBody.appendChild(tr);
       }
    }
  }

  // 指定した日時から slots 分連続で空いているかチェック
  function isAvailable(dateKey, startH, startM, neededSlots) {
    let currentH = startH;
    let currentM = startM;

    for (let i = 0; i < neededSlots; i++) {
      let timeStr = currentH + ":" + (currentM === 0 ? "00" : "30");
      let checkKey = dateKey + " " + timeStr;

      // 1. すでに予約が入っているか？（Setで高速チェック）
      if (bookedTimesSet.has(checkKey)) return false;
      
      // 2. 閉店時間(19:00)を超えるか？
      if (currentH >= 19) return false;

      // 30分進める
      currentM += 30;
      if (currentM >= 60) {
        currentM = 0;
        currentH++;
      }
    }
    return true;
  }

  // ○を押したときの処理
  function selectSlot(td, date, time) {
    // 選択状態のクリア
    let selected = document.querySelector('.calendar-table td.selected');
    if (selected) selected.classList.remove('selected');
    
    // 選択
    td.classList.add('selected');

    // 隠しフォームにセット
    document.getElementById('selectedDate').value = date;
    document.getElementById('selectedTime').value = time;
    
    // 名前入力欄を表示
    document.getElementById('userInfoArea').style.display = 'block';
    
    // スクロール
    document.getElementById('userInfoArea').scrollIntoView({behavior: "smooth"});
  }

  function prevWeek() {
    currentBaseDate.setDate(currentBaseDate.getDate() - 7);
    renderWeekCalendar();
  }
  function nextWeek() {
    currentBaseDate.setDate(currentBaseDate.getDate() + 7);
    renderWeekCalendar();
  }

  function submitData() {
    var form = document.getElementById('bookingForm');
    var menuSelect = document.getElementById('menuInput');
    var slots = menuSelect.options[menuSelect.selectedIndex].getAttribute('data-slots');
    
    var data = {
      date: document.getElementById('selectedDate').value,
      time: document.getElementById('selectedTime').value,
      name: form.name.value,
      menu: form.menu.value,
      inquiry: form.inquiry.value,
      slots: slots
    };

    if(!data.date || !data.time || !data.name) { alert("日時とお名前を入力してください"); return; }

    var btn = document.getElementById('submitBtn');
    btn.disabled = true;
    btn.textContent = "送信中...";

    fetch(GAS_API_URL, {
      method: 'POST',
      headers: { "Content-Type": "text/plain" },
      body: JSON.stringify(data)
    })
    .then(res => res.text())
    .then(msg => {
      document.getElementById('booking-area').style.display = 'none';
      document.getElementById('success-area').style.display = 'block';
      window.scrollTo(0,0);
      if (liff && liff.isLoggedIn()) {
         var msgText = "Web予約完了\n" + data.date + " " + data.time + "\n" + data.menu;
         liff.sendMessages([{ 'type': 'text', 'text': msgText }]).catch(e => console.log(e));
      }
    })
    .catch(err => {
      alert("送信エラー: " + err);
      btn.disabled = false;
      btn.textContent = "予約を確定する";
    });
  }

  function closeLiff() { if (liff) liff.closeWindow(); }
</script>

</body>
</html>
