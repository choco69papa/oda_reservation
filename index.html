<!DOCTYPE html>
<html>
<head>
    <base target="_top">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.bundle.min.js"></script>
    <script src="https://static.line-scdn.net/liff/edge/2.1/sdk.js"></script>
    <style>
        body { font-family: "Helvetica Neue", Arial, sans-serif; background-color: #f8f9fa; padding-bottom: 50px; }
        .container { max-width: 600px; margin-top: 20px; }
        .time-slot, .time-slot-ng {
            padding: 10px 5px; text-align: center; border-radius: 5px; cursor: pointer; border: 1px solid #ddd; background: #fff;
        }
        .time-slot:hover { background-color: #e2e6ea; }
        .selected-slot { background-color: #007bff !important; color: #fff; border-color: #007bff; }
        .symbol-ok { color: #28a745; font-weight: bold; font-size: 1.2em; }
        .symbol-ng { color: #dc3545; font-weight: bold; font-size: 1.2em; }
        .time-slot-ng { background-color: #f1f1f1; cursor: not-allowed; color: #ccc; }
        h4 { border-bottom: 2px solid #007bff; padding-bottom: 10px; margin-bottom: 20px; color: #333; }
        .loading { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.8); z-index: 9999; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; color: #007bff; }
    </style>
</head>
<body>

    <div id="loadingMsg" class="loading">
        <div class="spinner-border text-primary mr-2" role="status"></div>
        読み込み中...
    </div>

    <div class="container">
        
        <div id="success-area" style="display:none; text-align:center; padding: 40px 20px;">
            <div class="alert alert-success" role="alert">
                <h4 class="alert-heading">送信完了</h4>
                <p>ご予約ありがとうございます。<br>LINEにメッセージを送信しました。</p>
                <hr>
                <p class="mb-0">この画面を閉じてお待ちください。</p>
            </div>
        </div>

        <div id="booking-form">
            <h4 class="text-center">予約フォーム</h4>
            
            <div id="line-urgent-msg" style="display:none;" class="alert alert-info small">
                LINEから自動入力されます
            </div>

            <form>
                <input type="hidden" id="selected_date" name="date">
                <input type="hidden" id="selected_time" name="minute">

                <div class="form-group">
                    <label>お名前 <span class="badge badge-danger">必須</span></label>
                    <input type="text" class="form-control" name="namelabel" placeholder="例：山田 太郎" required>
                </div>

                <div id="web-contact-area" style="display:none;">
                   <div class="form-group">
                       <label>電話番号 <span class="badge badge-danger">必須</span></label>
                       <input type="tel" class="form-control" name="user_phone" placeholder="09012345678">
                   </div>
                   <div class="form-group">
                       <label>メールアドレス <span class="badge badge-danger">必須</span></label>
                       <input type="email" class="form-control" name="user_email" placeholder="sample@example.com">
                   </div>
                </div>

                <div class="form-group">
                    <label>メニュー選択 <span class="badge badge-danger">必須</span></label>
                    <select class="form-control" name="names" required>
                        <option value="" disabled selected>メニューを選択してください</option>
                        <option value="カット">カット</option>
                        <option value="カラー">カラー</option>
                        <option value="カット＋カラー">カット＋カラー</option>
                        <option value="パーマ">パーマ</option>
                        <option value="縮毛矯正">縮毛矯正</option>
                        <option value="縮毛矯正＋カット">縮毛矯正＋カット</option>
                        <option value="トリートメント">トリートメント</option>
                        <option value="ヘッドスパ">ヘッドスパ</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>日時選択 <span class="badge badge-danger">必須</span></label>
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <button class="btn btn-outline-secondary btn-sm" id="prevWeek">&lt; 前の週</button>
                        <span id="currentMonthDisplay" class="font-weight-bold"></span>
                        <button class="btn btn-outline-secondary btn-sm" id="nextWeek">次の週 &gt;</button>
                    </div>
                    
                    <div class="table-responsive">
                        <table class="table table-bordered text-center table-sm" style="table-layout: fixed; min-width: 300px;">
                            <thead class="thead-light">
                                <tr id="dateHeader"></tr>
                            </thead>
                            <tbody id="timeBody"></tbody>
                        </table>
                    </div>
                </div>

                <div class="form-group">
                    <label>お問い合わせ内容</label>
                    <textarea class="form-control" name="inquiries" rows="3" placeholder="ご質問やご要望があればご記入ください"></textarea>
                </div>

                <div class="text-center mt-4">
                    <input type="submit" class="btn btn-primary btn-lg btn-block" value="予約を確定する">
                </div>
            </form>
        </div>
    </div>

    <iframe name="hidden_iframe" id="hidden_iframe" style="display:none;"></iframe>

    <script>
    $(function () {
        // =================================================================
        // ★設定エリア
        // =================================================================
        
        // ① カズさんのLIFF ID
        const MY_LIFF_ID = "1657883881-JG16djMv"; 

        // ② GASのURL
        const GAS_API_URL = 'https://script.google.com/macros/s/AKfycbzA8kNadh-iMO7z2ZNNRHILRYUUm6wRZqhqvJ4nUdH_AMXetkfswTbvvKk3-MlzPHmmgA/exec';

        // =================================================================

        // フォームの送信先を設定
        $('form').attr('action', GAS_API_URL).attr('target', 'hidden_iframe').attr('method', 'post');
        
        // スマホ判定
        const isLineApp = navigator.userAgent.toLowerCase().indexOf('line') !== -1;

        // LIFF初期化
        if (typeof liff !== 'undefined') {
            liff.init({ liffId: MY_LIFF_ID }).then(() => {
                if (isLineApp) {
                    $('#web-contact-area').hide();
                    $('#line-urgent-msg').show();
                    $('input[name="user_email"]').prop('required', false);
                    $('input[name="user_phone"]').prop('required', false);
                    
                    if (!liff.isLoggedIn()) {
                        liff.login();
                    }
                } else {
                    showWebFields();
                }
            }).catch(err => {
                if (!isLineApp) showWebFields();
            });
        } else {
            if (!isLineApp) showWebFields();
        }

        function showWebFields() {
            $('#web-contact-area').show();
            $('input[name="user_email"]').prop('required', true);
            $('input[name="user_phone"]').prop('required', true);
        }

        // カレンダー設定
        let currentBaseDate = new Date();
        let bookedSlots = [];

        // ★読み込み処理
        function fetchAndRender() {
            $('#loadingMsg').show();
            const bustCache = '?t=' + new Date().getTime();
            
            fetch(GAS_API_URL + bustCache)
                .then(response => response.json())
                .then(data => {
                    bookedSlots = data;
                    renderCalendar(currentBaseDate);
                    $('#loadingMsg').hide();
                })
                .catch(error => {
                    console.error("読み込みエラー:", error);
                    renderCalendar(currentBaseDate); // エラーでもカレンダーは出す
                    $('#loadingMsg').hide();
                });
        }

        // ★カレンダー描画機能
        function renderCalendar(baseDate) {
            const $header = $('#dateHeader');
            const $body = $('#timeBody');
            const days = ['日', '月', '火', '水', '木', '金', '土'];
            const now = new Date();

            $header.empty().append('<th>時間</th>');
            $body.empty();

            $('#currentMonthDisplay').text((baseDate.getMonth() + 1) + "月");

            // 1週間分の日付データを作る
            let weekDates = [];
            let tempDate = new Date(baseDate);
            
            // 左端の日付調整（必要ならここを変更）
            // let dayOfWeek = tempDate.getDay();
            // tempDate.setDate(tempDate.getDate() - dayOfWeek);

            for (let i = 0; i < 7; i++) {
                let m = tempDate.getMonth() + 1;
                let d = tempDate.getDate();
                let w = tempDate.getDay(); 
                let fullDate = `${tempDate.getFullYear()}/${m}/${d}`;
                
                // ★定休日判定
                let isHoliday = false;
                // 1. 毎週月曜
                if (w === 1) isHoliday = true;
                // 2. 第3火曜
                if (w === 2 && d >= 15 && d <= 21) isHoliday = true;

                weekDates.push({
                    fullDate: fullDate,
                    isHoliday: isHoliday,
                    day: d,
                    weekParam: w
                });

                // ヘッダーの色付け
                let colorClass = '';
                if (w === 0) colorClass = 'text-danger'; 
                else if (w === 6) colorClass = 'text-primary'; 
                else if (isHoliday) colorClass = 'text-danger'; 

                $header.append(`<th class="${colorClass}">${d}<br><small>(${days[w]})</small></th>`);
                
                tempDate.setDate(tempDate.getDate() + 1);
            }

            // ★★★ ここを修正しました（9:00～18:00、1時間間隔） ★★★
            const timeList = [];
            for (let h = 9; h <= 18; h++) {
                timeList.push(h + ":00");
                // :30 は削除しました
            }
            // ★★★★★★★★★★★★★★★★★★★★★★★★★★★★★

            timeList.forEach(timeStr => {
                let row = `<tr><td class="bg-light font-weight-bold" style="font-size:10px;">${timeStr}</td>`;
                
                weekDates.forEach((dateObj) => {
                    let dObj = new Date(dateObj.fullDate + " " + timeStr);
                    let checkKey = dateObj.fullDate + " " + timeStr;
                    let wholeDayKey = dateObj.fullDate + " 休";
                    
                    // 定休日、または予約済み、または過去なら「×」
                    if (dateObj.isHoliday || bookedSlots.includes(wholeDayKey) || bookedSlots.includes(checkKey) || dObj < now) {
                        
                        let content = '<span class="symbol-ng">×</span>';
                        if (dateObj.isHoliday) {
                            content = '<span class="symbol-ng" style="color:#ff9999; font-size:10px;">休</span>';
                        }
                        row += `<td><div class="time-slot-ng">${content}</div></td>`;

                    } else {
                        row += `<td><div class="time-slot" data-date="${dateObj.fullDate}" data-time="${timeStr}"><span class="symbol-ok">〇</span></div></td>`;
                    }
                });
                $body.append(row + '</tr>');
            });
        }

        fetchAndRender(); // 初回実行

        // 週移動ボタン
        $('#prevWeek').on('click', function(e){
            e.preventDefault();
            currentBaseDate.setDate(currentBaseDate.getDate() - 7);
            renderCalendar(currentBaseDate);
        });
        $('#nextWeek').on('click', function(e){
            e.preventDefault();
            currentBaseDate.setDate(currentBaseDate.getDate() + 7);
            renderCalendar(currentBaseDate);
        });

        // 時間選択クリック
        $(document).on('click', '.time-slot', function() {
            $('.selected-slot').removeClass('selected-slot');
            $(this).addClass('selected-slot');
            $('#selected_date').val($(this).data('date'));
            $('#selected_time').val($(this).data('time'));
        });

        // 送信処理
        let submitted = false;
        $('form').submit(function (e) {
            var date = $('#selected_date').val();
            var minute = $('#selected_time').val();
            if(!date || !minute) { alert("予約日時を選択してください"); e.preventDefault(); return false; }

            if (!isLineApp) {
                 var phone = $('input[name="user_phone"]').val();
                 if (phone && phone.replace(/-/g, '').length !== 11) {
                     alert("電話番号はハイフンなしの11桁で入力してください。"); e.preventDefault(); return false;
                 }
            }
            
            submitted = true;
            $('input[type="submit"]').prop('disabled', true).val('送信中...');
            
            // 2秒後に強制完了画面へ
            setTimeout(function(){
                if(submitted) {
                    showSuccessScreen();
                }
            }, 2000);
        });

        $('#hidden_iframe').on('load', function() {
            if(submitted) {
                showSuccessScreen();
            }
        });

        // 完了画面＆LINEメッセージ送信
        function showSuccessScreen() {
            if (!submitted) return;
            submitted = false;

            $('#booking-form').hide();
            $('#success-area').show();
            window.scrollTo(0, 0);

            if (isLineApp) {
                var namelabel = $('input[name="namelabel"]').val();
                var date = $('#selected_date').val();
                var minute = $('#selected_time').val();
                var names = $('select[name="names"]').val();
                var inquiries = $('textarea[name="inquiries"]').val();

                var msg = `＊＊ご予約内容＊＊\nお名前：\n${namelabel}\n希望日：\n${date}\n時間：\n${minute}\nメニュー：\n${names}\n問い合わせ内容：\n${inquiries}`;
                
                liff.sendMessages([{ 'type': 'text', 'text': msg }])
                    .then(function () {
                        setTimeout(function(){ liff.closeWindow(); }, 2000);
                    })
                    .catch(function (error) {
                        console.log("LINE送信失敗:", error);
                    });
            }
        }
    });
    </script>
</body>
</html>
