<!DOCTYPE html>
<html lang="ja">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>予約フォーム</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
    <style>
        /* カレンダー専用スタイル */
        .calendar-container { 
            font-size: 11px;
            margin-left: calc(-16.6vw + 15px) !important; 
            margin-right: calc(-16.6vw + 15px) !important;
            padding: 5px 0 !important;
            border-radius: 0 !important;
            border-left: none !important;
            border-right: none !important;
        }
        .table { 
            table-layout: fixed; 
            width: 100% !important; 
            margin-bottom: 0 !important;
        }
        .table th:first-child, .table td:first-child { 
            width: 45px !important; 
            padding: 8px 2px !important;
            font-size: 10px;
        }
        .table th, .table td { 
            padding: 10px 0 !important; 
            word-break: break-all;
        }
        .table-responsive { 
            max-height: 400px; 
            overflow-y: auto; 
            overflow-x: hidden !important;
            background: white; 
        }
        .time-slot { cursor: pointer; display: block; padding: 5px 0; }
        .symbol-ok { color: #28a745; font-weight: bold; font-size: 1.1rem; }
        .symbol-ng { color: #ccc; cursor: not-allowed; }
        .selected-slot { background-color: #007bff !important; color: white !important; }
        .selected-slot .symbol-ok { color: white; }
        
        /* ローディングオーバーレイ */
        #loading {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.8); z-index: 9999;
            display: flex; justify-content: center; align-items: center;
            flex-direction: column;
        }
        .spinner-border { width: 3rem; height: 3rem; }
    </style>
</head>
<body>
    <div id="loading">
        <div class="spinner-border text-primary" role="status">
            <span class="sr-only">Loading...</span>
        </div>
        <div class="mt-2 text-primary font-weight-bold">予約状況を確認中...</div>
    </div>

    <form class="w-75 mx-auto">
        <span style="color:#ff0000;">お急ぎの方はLINE電話からお願いします</span>
        <p class="mt-3">予約情報を入力して送信ボタンを押してください。</p>
        
        <p class="mt-3">お名前</p>
        <div>
            <input type="text" name="namelabel" class="form-control" required>
        </div>    

        <p class="mt-3">予約日時を選択してください</p>
        <input type="hidden" name="date" id="selected_date" required>
        <input type="hidden" name="minute" id="selected_time" required>

        <div class="calendar-container border rounded p-2 bg-light">
            <div class="d-flex justify-content-between align-items-center mb-2 px-2">
                <button type="button" id="prevWeek" class="btn btn-sm btn-outline-secondary">＜ 前の週</button>
                <span id="currentMonthDisplay" style="font-weight:bold;"></span>
                <button type="button" id="nextWeek" class="btn btn-sm btn-outline-secondary">次の週 ＞</button>
            </div>
            <div class="table-responsive">
                <table class="table table-bordered text-center mb-0">
                    <thead class="thead-light">
                        <tr id="dateHeader"></tr>
                    </thead>
                    <tbody id="timeBody"></tbody>
                </table>
            </div>
        </div>

        <p class="mt-3">メニュー</p>
        <select class="form-control w-100 mt-1" name="names" required>
            <option value="">メニューを選択</option>
            <option value="カット">カット</option>
            <option value="パーマ ＋ カット">パーマ ＋ カット</option>
            <option value="カラー ＋ カット">カラー ＋ カット</option>
            <option value="トリートメント">トリートメント</option>
            <option value="縮毛矯正 ＋ カット">縮毛矯正 ＋ カット</option>
            <option value="まつ毛カール">まつ毛カール</option>
            <option value="まつ毛エクステ">まつ毛エクステ</option>
            <option value="トリートメントストレートパーマ">トリートメントストレートパーマ</option>
            <option value="着付け">着付け</option>
        </select>
        
        <p class="mt-3">お問い合わせ</p>
        <div>
            <textarea class="form-control w-100 mt-1" name="inquiries" rows="3" cols="40"></textarea>
        </div>
        <br>
        <span style="color:#ff0000;">注）送信後、完了メッセージが出るまでお待ちください。</span>
    
        <input type="submit" class="mt-4 btn btn-primary w-100" value="予約する">
    </form>

    <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js"></script>
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2.1/sdk.js"></script>
    <script>
    // ▼▼▼ ここにGASのウェブアプリURLを貼り付けてください ▼▼▼
    const GAS_URL = "https://script.google.com/macros/s/AKfycbzbMVsrdEcxcyJtHNYZWwC0BzkdYSKGO8cvnLogsDqQtyTbMI33Ztu2k3g4c0JEJBs2/exec";
    // ▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲

    $(function () {
        // LIFF初期化
        liff.init({ liffId: "あなたのLIFF_ID" }).then(() => {
            // 初期化成功
        }).catch((err) => {
            console.log(err);
        });

        // 予約済みリスト格納用
        let bookedSlots = [];

        // ページ読み込み時に予約状況を取得
        fetch(GAS_URL)
            .then(response => response.json())
            .then(data => {
                bookedSlots = data; // ["2026年01月07日_10：00～", ...] の形式で入る
                renderCalendar(currentBaseDate); // カレンダー再描画
                $('#loading').fadeOut(); // ローディング消す
            })
            .catch(error => {
                console.error('Error:', error);
                alert("予約状況の取得に失敗しました。通信環境を確認してください。");
                $('#loading').fadeOut();
            });

        // --- カレンダー生成ロジック ---
        let currentBaseDate = new Date();
        currentBaseDate.setDate(currentBaseDate.getDate() - currentBaseDate.getDay()); // 日曜始まり

        const startH = 9;  
        const endH = 17;   

        function renderCalendar(baseDate) {
            const $header = $('#dateHeader');
            const $body = $('#timeBody');
            const days = ['日', '月', '火', '水', '木', '金', '土'];
            const now = new Date(); 
            
            $header.empty().append('<th>時間</th>');
            $body.empty();
            
            let monthText = (baseDate.getMonth() + 1) + "月";
            $('#currentMonthDisplay').text(monthText);

            let weekDates = [];
            let tempDate = new Date(baseDate);

            // ヘッダー作成
            for (let i = 0; i < 7; i++) {
                let m = tempDate.getMonth() + 1;
                let d = tempDate.getDate();
                let w = tempDate.getDay();
                
                // GASとの照合用にフォーマットを統一
                let displayDate = `${tempDate.getFullYear()}年${('0'+m).slice(-2)}月${('0'+d).slice(-2)}日`;
                let fullDate = `${tempDate.getFullYear()}/${m}/${d}`; // 計算用
                
                weekDates.push({ fullDate: fullDate, displayDate: displayDate });
                
                let color = (w === 0) ? 'text-danger' : (w === 6) ? 'text-primary' : '';
                $header.append(`<th class="${color}">${d}<br><small>(${days[w]})</small></th>`);
                tempDate.setDate(tempDate.getDate() + 1);
            }

            // 時間枠作成
            for (let h = startH; h < endH; h++) {
                let timeStr = `${h}:00`;
                let timeLabel = `${h}：00～`; // GASとの照合用文字列
                let row = `<tr><td class="bg-light font-weight-bold">${h}:00</td>`;
                
                weekDates.forEach((dateObj) => {
                    let dObj = new Date(dateObj.fullDate + " " + timeStr);
                    
                    // 条件判定
                    let isMonday = (dObj.getDay() === 1);
                    let isThirdTuesday = (dObj.getDay() === 2 && Math.ceil(dObj.getDate() / 7) === 3);
                    let isPast = (dObj < now);

                    // ★ GASから取得した予約済みチェック ★
                    // 日付と時間を結合してチェック (例: "2026年01月07日_10：00～")
                    let slotKey = dateObj.displayDate + '_' + timeLabel;
                    let isBooked = bookedSlots.includes(slotKey);

                    if (isMonday || isThirdTuesday || isPast || isBooked) {
                        row += `<td><span class="symbol-ng">×</span></td>`;
                    } else {
                        row += `<td><div class="time-slot" data-date="${dateObj.displayDate}" data-time="${timeLabel}">
                                    <span class="symbol-ok">〇</span>
                                </div></td>`;
                    }
                });
                $body.append(row + '</tr>');
            }
        }

        // 週切り替え
        $('#prevWeek').on('click', function(e){ 
            e.preventDefault(); 
            currentBaseDate.setDate(currentBaseDate.getDate() - 7); 
            renderCalendar(currentBaseDate); 
        });
        $('#nextWeek').on('click', function(e){ 
            e.preventDefault(); 
            currentBaseDate.setDate(currentBaseDate.getDate() + 7); 
            renderCalendar(currentBaseDate); 
        });

        // 選択処理
        $(document).on('click', '.time-slot', function() {
            $('.selected-slot').removeClass('selected-slot');
            $(this).addClass('selected-slot');
            $('#selected_date').val($(this).data('date'));
            $('#selected_time').val($(this).data('time'));
        });

        // 送信処理（ここが一番重要！）
        $('form').submit(function (e) {
            e.preventDefault();
            
            var namelabel = $('input[name="namelabel"]').val();
            var date = $('#selected_date').val();
            var minute = $('#selected_time').val();
            var names = $('select[name="names"]').val();
            var inquiries = $('textarea[name="inquiries"]').val();
            
            if(!date || !minute) {
                alert("予約日時を選択してください");
                return false;
            }

            if(!confirm(date + " " + minute + "\nこの日時で予約しますか？")) {
                return false;
            }

            // ローディング表示
            $('#loading').find('div.text-primary').text('予約を処理しています...');
            $('#loading').fadeIn();

            // 1. まずGASにデータを送って重複チェック＆保存
            const postData = {
                date: date,
                time: minute,
                name: namelabel,
                menu: names,
                inquiry: inquiries
            };

            fetch(GAS_URL, {
                method: 'POST',
                mode: 'no-cors', // 重要: GASへのPOSTはno-corsだとレスポンス読めないが、textOutput返すならcorsが必要、今回は簡易実装としてredirect利用
                headers: {
                    'Content-Type': 'text/plain' // GASのdoPostはtext/plainで送るのが安定
                },
                body: JSON.stringify(postData)
            })
            .then(response => response.json()) // GASからJSONが返ってくる
            .then(result => {
                $('#loading').fadeOut();

                if(result.result === 'success') {
                    // 2. 予約成功したらLINEに送る
                    var msg = `＊＊ご予約完了＊＊\nお名前：\n ${namelabel}\n希望日：\n ${date}\n時間：\n ${minute}\nメニュー：\n ${names}\n問い合わせ内容：\n ${inquiries}`;
                    sendText(msg);
                } else {
                    // 重複エラー
                    alert(result.message);
                    // 状況が変わったので最新情報を再取得してリロード
                    location.reload(); 
                }
            })
            .catch(error => {
                $('#loading').fadeOut();
                // ※ GASの仕様上、CORSエラーが出ても実際は成功している場合があるが、
                // redirect設定を正しく行えばjsonを受け取れます。
                // もしエラーになる場合は、fetchの設定調整が必要です。
                // とりあえずアラートを出します。
                console.error(error);
                alert("通信エラーが発生しました。");
            });

            return false;
        });

        function sendText(text) {
            if (!liff.isInClient()) {
                alert('LINEアプリ外ではメッセージ送信できませんが、予約は完了しました。');
                return;
            }
            liff.sendMessages([{
                'type': 'text',
                'text': text
            }]).then(function () {
                liff.closeWindow();
            }).catch(function (error) {
                alert('LINE送信に失敗しました');
            });
        }
    });
    </script>
</body>
</html>
