<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>予約フォーム</title>
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; padding-top: 20px; padding-bottom: 50px; color: #333; }
        .container { padding-left: 12px; padding-right: 12px; max-width: 600px; }
        h4 { text-align: center; font-weight: bold; margin-bottom: 25px; }
        .table-responsive { border: none; margin-bottom: 1rem; overflow-x: auto; -webkit-overflow-scrolling: touch; }
        .table { table-layout: fixed; width: 100%; min-width: 350px; background-color: #fff; margin-bottom: 0; }
        .table th, .table td { text-align: center; vertical-align: middle; padding: 4px 0px !important; font-size: 11px; height: 45px; border: 1px solid #dee2e6; }
        .table th:first-child, .table td:first-child { width: 45px; background-color: #f1f1f1; font-weight: bold; font-size: 10px; }
        
        /* カズさんのデザインクラス */
        .time-slot, .time-slot-ng { height: 100%; width: 100%; display: flex; align-items: center; justify-content: center; }
        .time-slot { cursor: pointer; color: #28a745; font-weight: bold; font-size: 16px; }
        .time-slot-ng { background-color: #f9f9f9; color: #ccc; }
        .selected-slot { background-color: #28a745 !important; color: #fff !important; }
        .selected-slot .time-slot { color: #fff !important; } /* 選択時の文字色 */

        .text-danger { color: #dc3545 !important; }
        .text-primary { color: #007bff !important; }
        .week-nav { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding: 0 2px; }
        .month-label { font-size: 1.2rem; font-weight: bold; }
        label { font-weight: bold; font-size: 1rem; margin-top: 15px; }
        .required-badge { background-color: #dc3545; color: white; font-size: 0.75rem; padding: 3px 6px; border-radius: 4px; margin-left: 8px; vertical-align: middle; }
        .form-control { height: calc(1.5em + 1rem + 2px); padding: 0.5rem 1rem; font-size: 1rem; }
        .btn-block { padding: 12px; font-size: 1.1rem; font-weight: bold; margin-top: 30px; }
        
        /* ローディング */
        #loadingMsg { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.8); z-index:9999; text-align:center; padding-top:200px; font-weight:bold; color:#007bff; }
        
        /* 完了画面 */
        .success-icon { font-size: 80px; color: #555; margin-bottom: 20px; font-weight: bold; }
        .success-title { font-size: 1.5rem; font-weight: bold; margin-bottom: 20px; color: #333; }
        .success-msg { font-size: 1rem; line-height: 1.8; margin-bottom: 40px; }
        .btn-gray { background-color: #6c757d; color: white; padding: 10px 30px; border-radius: 5px; font-size: 1rem; }
    </style>
</head>
<body>

<div id="loadingMsg">
    <div class="spinner-border text-primary" role="status"></div>
    <br>読み込み中...
</div>

<div class="container" id="booking-form">
    <form id="mainForm">
        <div class="form-group">
            <label>お名前<span class="required-badge">必須</span></label>
            <input type="text" name="name" class="form-control" placeholder="例：ビューティー 花子" required>
        </div>

        <div class="form-group">
            <label>メニュー<span class="required-badge">必須</span></label>
            <select name="menu" id="menuInput" class="form-control" required onchange="renderWeekCalendar()">
                <option value="" data-slots="0">▼メニューを選択（空き状況が表示されます）</option>
                <option value="カット" data-slots="2">カット（約60分）</option>
                <option value="カラー＋カット" data-slots="5">カラー＋カット（約150分）</option>
                <option value="パーマ＋カット" data-slots="5">パーマ＋カット（約150分）</option>
                <option value="トリートメント" data-slots="2">トリートメント（約40分）</option>
                <option value="縮毛矯正＋カット" data-slots="6">縮毛矯正＋カット（約180分）</option>
                <option value="まつ毛パーマ" data-slots="2">まつ毛パーマ（60分）</option>
                <option value="まつげエクステ" data-slots="3">まつげエクステ（90分）</option>
                <option value="着付け" data-slots="2">着付け（約60分）</option>
            </select>
        </div>

        <div style="margin-top: 30px;" id="calendarSection" style="display:none;">
            <label>予約日時を選択してください<span class="required-badge">必須</span></label>
            
            <div class="week-nav">
                <button type="button" id="prevWeek" class="btn btn-outline-secondary" onclick="prevWeek()">&lt; 前の週</button>
                <span id="currentMonthDisplay" class="month-label"></span>
                <button type="button" id="nextWeek" class="btn btn-primary" onclick="nextWeek()">次の週 &gt;</button>
            </div>

            <div class="table-responsive">
                <table class="table table-bordered">
                    <thead><tr id="dateHeader"></tr></thead>
                    <tbody id="timeBody"></tbody>
                </table>
            </div>
            <div class="text-center text-muted mb-3" style="font-size:0.85rem;">
                ※「〇」をタップして時間を選択してください
            </div>
        </div>

        <input type="hidden" id="selected_date" name="date">
        <input type="hidden" id="selected_time" name="time">

        <div class="form-group">
            <label>お問い合わせ</label>
            <textarea name="inquiry" class="form-control" rows="3" style="height: auto;" placeholder="ご要望などがあればご記入ください"></textarea>
        </div>

        <button type="button" id="submitBtn" class="btn btn-success btn-block" onclick="submitData()">予約を確定する</button>
    </form>
</div>

<div class="container" id="success-area" style="display:none; text-align:center; padding-top:80px;">
    <div class="success-icon">✔</div>
    <div class="success-title">予約を受け付けました</div>
    <div class="success-msg">
        ご予約ありがとうございます。<br>
        確認後、LINEにてご連絡いたします。
    </div>
    <button onclick="closeLiff()" class="btn btn-gray">閉じる</button>
</div>

<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<script>
    // ★★★ ここにGASのURL（/execで終わるやつ）を貼ってください ★★★
    const GAS_API_URL = "https://script.google.com/macros/s/AKfycby7T82gguG2KXD37D0Se-JN7ZgzhW2Rp51bpnQggd8bM41im4VHDDZIgPXxxDUSYg45RA/exec";
    const MY_LIFF_ID = "1657883881-JG16djMv";

    let bookedTimesSet = new Set();
    let currentBaseDate = new Date();

    window.onload = function() {
        // LIFF初期化
        if(typeof liff !== 'undefined'){
            liff.init({ liffId: MY_LIFF_ID }).then(() => {
                if (!liff.isLoggedIn()) liff.login();
            }).catch(err => console.log(err));
        }
        // データ取得
        fetchBookedData();
    };

    function fetchBookedData() {
        document.getElementById('loadingMsg').style.display = 'block';
        fetch(GAS_API_URL + '?p=json')
            .then(res => res.json())
            .then(data => {
                bookedTimesSet.clear();
                data.forEach(dt => {
                    let parts = dt.split(' ');
                    if(parts.length === 2) {
                        let dParts = parts[0].split('/');
                        let normalDate = parseInt(dParts[0]) + '/' + parseInt(dParts[1]) + '/' + parseInt(dParts[2]);
                        bookedTimesSet.add(normalDate + ' ' + parts[1]);
                    }
                });
                document.getElementById('loadingMsg').style.display = 'none';
                renderWeekCalendar();
            })
            .catch(err => {
                console.error("通信エラー", err);
                document.getElementById('loadingMsg').style.display = 'none';
                alert("データの読み込みに失敗しました");
            });
    }

    function renderWeekCalendar() {
        const menuSelect = document.getElementById('menuInput');
        const slots = parseInt(menuSelect.options[menuSelect.selectedIndex].getAttribute('data-slots') || 0);

        // メニュー未選択ならカレンダーの中身をクリアして終了
        if (slots === 0) {
            document.getElementById('timeBody').innerHTML = '<tr><td colspan="8">メニューを選択してください</td></tr>';
            return;
        }

        const headerRow = document.getElementById('dateHeader');
        const timeBody = document.getElementById('timeBody');
        headerRow.innerHTML = '<th>時間</th>';
        timeBody.innerHTML = '';

        // 日曜始まり計算
        let tempDate = new Date(currentBaseDate);
        tempDate.setDate(tempDate.getDate() - tempDate.getDay());

        const days = ['日', '月', '火', '水', '木', '金', '土'];
        let weekDates = [];

        // ヘッダー作成
        for (let i = 0; i < 7; i++) {
            let m = tempDate.getMonth() + 1;
            let d = tempDate.getDate();
            let w = tempDate.getDay();
            
            let thClass = '';
            if (w === 0) thClass = 'text-danger';
            if (w === 6) thClass = 'text-primary';

            let dateKey = tempDate.getFullYear() + '/' + m + '/' + d;
            
            // 定休日
            let isHoliday = false;
            if (w === 1) isHoliday = true; 
            if (w === 2 && d >= 15 && d <= 21) isHoliday = true;

            weekDates.push({ dateKey: dateKey, isHoliday: isHoliday, dateObj: new Date(tempDate) });

            let thHtml = `<th class="${thClass}">${d}<br><small>(${days[w]})</small></th>`;
            headerRow.insertAdjacentHTML('beforeend', thHtml);

            if (i === 0) {
                document.getElementById('currentMonthDisplay').innerText = `${m}月`;
            }
            tempDate.setDate(tempDate.getDate() + 1);
        }

        // 時間割作成 (9:00 - 18:00)
        for (let h = 9; h <= 18; h++) {
            // 00分
            createTimeRow(h, 0, weekDates, slots, timeBody);
            // 30分
            createTimeRow(h, 30, weekDates, slots, timeBody);
        }
    }

    function createTimeRow(h, m, weekDates, slots, container) {
        let timeStr = h + ":" + (m === 0 ? "00" : "30");
        let tr = document.createElement('tr');
        tr.innerHTML = `<td style="font-weight:bold; background:#f1f1f1;">${timeStr}</td>`;

        for (let i = 0; i < 7; i++) {
            let info = weekDates[i];
            let td = document.createElement('td');
            
            let targetDateTime = new Date(info.dateObj);
            targetDateTime.setHours(h, m, 0, 0);
            let now = new Date();

            if (info.isHoliday) {
                td.innerHTML = '<div class="time-slot-ng">休</div>';
            } else if (targetDateTime < now) {
                td.innerHTML = '<div class="time-slot-ng">-</div>';
            } else {
                if (isAvailable(info.dateKey, h, m, slots)) {
                    // ★ここがカズさんのデザイン（緑の〇）
                    td.innerHTML = '<div class="time-slot">〇</div>';
                    td.onclick = function() { selectSlot(this, info.dateKey, timeStr); };
                } else {
                    td.innerHTML = '<div class="time-slot-ng">×</div>';
                }
            }
            tr.appendChild(td);
        }
        container.appendChild(tr);
    }

    function isAvailable(dateKey, startH, startM, neededSlots) {
        let currentH = startH;
        let currentM = startM;
        for (let i = 0; i < neededSlots; i++) {
            let timeStr = currentH + ":" + (currentM === 0 ? "00" : "30");
            let checkKey = dateKey + " " + timeStr;
            if (bookedTimesSet.has(checkKey)) return false;
            if (currentH >= 19) return false;
            currentM += 30;
            if (currentM >= 60) { currentM = 0; currentH++; }
        }
        return true;
    }

    function selectSlot(td, date, time) {
        // 選択解除
        let selected = document.querySelector('.selected-slot');
        if (selected) selected.classList.remove('selected-slot');
        
        // 選択（親のtdにクラスをつける）
        td.parentElement.classList.add('selected-slot'); // divの親のtdにつける

        document.getElementById('selected_date').value = date;
        document.getElementById('selected_time').value = time;
    }

    function prevWeek() {
        currentBaseDate.setDate(currentBaseDate.getDate() - 7);
        renderWeekCalendar();
    }
    function nextWeek() {
        currentBaseDate.setDate(currentBaseDate.getDate() + 7);
        renderWeekCalendar();
    }

    function submitData() {
        var form = document.getElementById('mainForm');
        var menuSelect = document.getElementById('menuInput');
        var slots = menuSelect.options[menuSelect.selectedIndex].getAttribute('data-slots');
        
        var data = {
            date: document.getElementById('selected_date').value,
            time: document.getElementById('selected_time').value,
            name: form.name.value,
            menu: form.menu.value,
            inquiry: form.inquiry.value,
            slots: slots
        };

        if(!data.date || !data.time || !data.name) { alert("日時とお名前を入力してください"); return; }

        var btn = document.getElementById('submitBtn');
        btn.disabled = true;
        btn.textContent = "送信中...";

        fetch(GAS_API_URL, {
            method: 'POST',
            headers: { "Content-Type": "text/plain" },
            body: JSON.stringify(data)
        })
        .then(res => res.text())
        .then(msg => {
            document.getElementById('booking-form').style.display = 'none';
            document.getElementById('success-area').style.display = 'block';
            window.scrollTo(0,0);
            if (liff && liff.isLoggedIn()) {
                var msgText = "Web予約完了\n" + data.date + " " + data.time + "\n" + data.menu;
                liff.sendMessages([{ 'type': 'text', 'text': msgText }]).catch(e => console.log(e));
            }
        })
        .catch(err => {
            alert("送信エラー: " + err);
            btn.disabled = false;
            btn.textContent = "予約を確定する";
        });
    }

    function closeLiff() { if (liff) liff.closeWindow(); }
</script>

</body>
</html>
