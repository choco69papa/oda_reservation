<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>ご予約フォーム</title>
  <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background-color: #f8f9fa; padding: 20px; color: #333; font-family: sans-serif; }
    .container { max-width: 600px; background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
    /* 青い帯は出ません！ */
    label { font-weight: bold; margin-top: 15px; color: #555; }
    .required-badge { background-color: #dc3545; color: white; font-size: 0.7rem; padding: 2px 6px; border-radius: 4px; margin-left: 5px; vertical-align: middle; }
    .form-control { height: auto; padding: 12px; font-size: 16px; background: #fff; }
    select.form-control { -webkit-appearance: none; appearance: none; }
    .btn-block { padding: 15px; font-size: 1.2rem; font-weight: bold; margin-top: 30px; border-radius: 8px; }
    .loading-msg { display:none; color: #007bff; font-size: 0.9rem; margin-left: 10px; }
    #success-area { display:none; text-align:center; padding-top:50px; }
    .success-icon { font-size: 80px; color: #00B900; margin-bottom: 20px; }
    .success-title { font-size: 1.5rem; font-weight: bold; margin-bottom: 20px; }
  </style>
</head>
<body>

<div class="container" id="booking-area">
  <h4 class="text-center font-weight-bold text-success mb-4 pb-3 border-bottom">WEB予約</h4>
  <form id="bookingForm">
    <div class="form-group">
      <label>お名前<span class="required-badge">必須</span></label>
      <input type="text" name="name" class="form-control" placeholder="例：鈴木 花子" required>
    </div>

    <div class="form-group">
      <label>メニュー<span class="required-badge">必須</span></label>
      <select name="menu" id="menuInput" class="form-control" required onchange="updateAvailableTimes()">
        <option value="" data-slots="0">▼メニューを選択してください</option>
        <option value="カット" data-slots="2">カット（約60分）</option>
        <option value="カラー＋カット" data-slots="5">カラー＋カット（約150分）</option>
        <option value="パーマ＋カット" data-slots="5">パーマ＋カット（約150分）</option>
        <option value="トリートメント" data-slots="2">トリートメント（約40分）</option>
        <option value="縮毛矯正＋カット" data-slots="6">縮毛矯正＋カット（約180分）</option>
        <option value="まつ毛パーマ" data-slots="2">まつ毛パーマ（60分）</option>
        <option value="まつげエクステ" data-slots="3">まつげエクステ（90分）</option>
        <option value="着付け" data-slots="2">着付け（約60分）</option>
      </select>
    </div>

    <div class="form-group">
      <label>ご希望日<span class="required-badge">必須</span></label>
      <input type="date" name="date" id="dateInput" class="form-control" required onchange="updateAvailableTimes()">
    </div>

    <div class="form-group">
      <label>開始時間 <span id="loadingMsg" class="loading-msg">空き状況を確認中...</span><span class="required-badge">必須</span></label>
      <select name="time" id="timeInput" class="form-control" disabled required>
        <option value="">↑メニューと日付を選ぶと表示されます</option>
      </select>
    </div>
    
    <div class="form-group">
      <label>お問い合わせ</label>
      <textarea name="inquiry" class="form-control" rows="3" placeholder="ご要望などがあればご記入ください"></textarea>
    </div>

    <button type="button" id="submitBtn" class="btn btn-success btn-block" onclick="submitData()" disabled>予約を確定する</button>
  </form>
</div>

<div class="container" id="success-area">
  <div class="success-icon">✔</div>
  <div class="success-title">予約を受け付けました</div>
  <p>ご予約ありがとうございます。<br>内容を確認し、LINEにて完了通知をお送りします。</p>
  <button onclick="closeLiff()" class="btn btn-secondary mt-4">閉じる</button>
</div>

<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<script>
  // ★★★ 重要：ここにGASのURL（/execで終わるやつ）を貼る！ ★★★
  const GAS_API_URL = "https://script.google.com/macros/s/AKfycby7T82gguG2KXD37D0Se-JN7ZgzhW2Rp51bpnQggd8bM41im4VHDDZIgPXxxDUSYg45RA/exec";
  const MY_LIFF_ID = "1657883881-JG16djMv";

  let bookedTimesToday = [];

  window.onload = function() {
    if(typeof liff !== 'undefined'){
      liff.init({ liffId: MY_LIFF_ID }).then(() => {
        if (!liff.isLoggedIn()) liff.login();
      }).catch(err => console.log(err));
    }
  };

  function updateAvailableTimes() {
    var dateVal = document.getElementById('dateInput').value;
    var menuSelect = document.getElementById('menuInput');
    var slots = menuSelect.options[menuSelect.selectedIndex].getAttribute('data-slots') || 0;
    
    if (!dateVal || slots == 0) return;

    var timeSelect = document.getElementById('timeInput');
    timeSelect.disabled = true;
    timeSelect.innerHTML = '<option value="">確認中...</option>';
    document.getElementById('loadingMsg').style.display = "inline";

    var dateStr = dateVal.replace(/-/g, '/');

    // GitHubからGASへ空き状況を問い合わせる
    fetch(GAS_API_URL + '?p=json')
      .then(res => res.json())
      .then(bookedList => {
        // 全予約データから「その日」のものを抽出
        bookedTimesToday = bookedList.filter(s => s.startsWith(dateStr)).map(s => s.split(' ')[1]);
        generateTimeOptions(slots);
        document.getElementById('loadingMsg').style.display = "none";
      })
      .catch(err => {
        alert("通信エラー: " + err);
        document.getElementById('loadingMsg').style.display = "none";
      });
  }

  function generateTimeOptions(neededSlots) {
    var timeSelect = document.getElementById('timeInput');
    timeSelect.innerHTML = '<option value="">▼開始時間を選んでください</option>';
    var startHour = 9, endHour = 19;
    var hasOption = false;

    for (var h = startHour; h < endHour; h++) {
      for (var m = 0; m < 60; m += 30) {
        var checkTime = h + ":" + (m === 0 ? "00" : "30");
        if (isAvailable(h, m, neededSlots)) {
           var opt = document.createElement('option');
           opt.value = checkTime;
           opt.text = checkTime;
           timeSelect.appendChild(opt);
           hasOption = true;
        }
      }
    }
    if (hasOption) {
      timeSelect.disabled = false;
      document.getElementById('submitBtn').disabled = false;
    } else {
      timeSelect.innerHTML = '<option value="">空きがありません</option>';
    }
  }

  function isAvailable(startH, startM, slots) {
    var currentH = startH, currentM = startM;
    for (var i = 0; i < slots; i++) {
      var timeStr = currentH + ":" + (currentM === 0 ? "00" : "30");
      if (bookedTimesToday.indexOf(timeStr) !== -1) return false;
      if (currentH >= 19) return false;
      currentM += 30;
      if (currentM >= 60) { currentM = 0; currentH++; }
    }
    return true;
  }

  function submitData() {
    var form = document.getElementById('bookingForm');
    var menuSelect = document.getElementById('menuInput');
    var slots = menuSelect.options[menuSelect.selectedIndex].getAttribute('data-slots');
    
    var data = {
      date: form.date.value.replace(/-/g, '/'),
      time: form.time.value,
      name: form.name.value,
      menu: form.menu.value,
      inquiry: form.inquiry.value,
      slots: slots
    };

    if(!data.date || !data.time) return;

    var btn = document.getElementById('submitBtn');
    btn.disabled = true;
    btn.textContent = "送信中...";

    // GitHubからGASへデータを送信（特例的な書き方）
    fetch(GAS_API_URL, {
      method: 'POST',
      headers: { "Content-Type": "text/plain" }, // これが重要
      body: JSON.stringify(data)
    })
    .then(res => res.text())
    .then(msg => {
      document.getElementById('booking-area').style.display = 'none';
      document.getElementById('success-area').style.display = 'block';
      window.scrollTo(0,0);
      if (liff && liff.isLoggedIn()) {
         var msgText = "Web予約完了\n" + data.date + " " + data.time + "\n" + data.menu;
         liff.sendMessages([{ 'type': 'text', 'text': msgText }]).catch(e => console.log(e));
      }
    })
    .catch(err => {
      alert("送信エラー: " + err);
      btn.disabled = false;
      btn.textContent = "予約を確定する";
    });
  }

  function closeLiff() { if (liff) liff.closeWindow(); }
</script>
</body>
</html>
