<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>予約カレンダー</title>
  <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background-color: #f8f9fa; color: #333; font-family: sans-serif; padding-bottom: 40px; }
    .container { max-width: 600px; background: white; padding: 20px; margin-top: 10px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }

    /* タイトルなどのスタイル */
    h5 { font-weight: bold; color: #00B900; border-bottom: 2px solid #f1f1f1; padding-bottom: 15px; margin-bottom: 20px; text-align: center; }
    label { font-weight: bold; margin-top: 10px; color: #555; font-size: 0.9rem; }
    .required-badge { background-color: #dc3545; color: white; font-size: 0.7rem; padding: 2px 6px; border-radius: 4px; margin-left: 5px; vertical-align: middle; }
    .form-control { font-size: 1rem; }

    /* ★週間カレンダーのスタイル★ */
    .week-nav { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
    .current-month { font-size: 1.1rem; font-weight: bold; } /* 太すぎず普通に */

    .table-responsive { overflow-x: auto; -webkit-overflow-scrolling: touch; }
    .calendar-table { width: 100%; min-width: 350px; border-collapse: collapse; table-layout: fixed; }
    
    .calendar-table th { text-align: center; font-size: 0.8rem; background: #f8f9fa; padding: 5px 0; border: 1px solid #dee2e6; }
    .calendar-table td { text-align: center; vertical-align: middle; height: 45px; border: 1px solid #dee2e6; font-size: 1.2rem; cursor: pointer; }

    /* 記号のスタイル */
    .symbol-ok { color: #00B900; font-weight: bold; } /* ◯ */
    .symbol-ng { color: #ccc; font-size: 1rem; } /* × */
    .symbol-rest { color: #dc3545; font-size: 0.9rem; } /* 休 */

    /* 選択されたセル */
    .calendar-table td.selected { background-color: #00B900; color: white !important; }
    .calendar-table td.selected .symbol-ok { color: white; }

    /* 曜日色 */
    .th-sun { color: #dc3545; background-color: #fff0f0 !important; }
    .th-sat { color: #007bff; background-color: #f0f8ff !important; }

    /* 完了画面 */
    #success-area { display:none; text-align:center; padding-top:50px; }
    .success-icon { font-size: 80px; color: #00B900; margin-bottom: 20px; }
  </style>
</head>
<body>

<div class="container" id="booking-area">
  
  <form id="bookingForm">
    <div class="form-group">
      <label>お名前<span class="required-badge">必須</span></label>
      <input type="text" name="name" class="form-control" placeholder="例：ビューテイー 花子" required>
    </div>

    <div class="form-group">
      <label>メニュー<span class="required-badge">必須</span></label>
      <select name="menu" id="menuInput" class="form-control" required onchange="renderWeekCalendar()">
        <option value="" data-slots="0">▼メニューを選択してください</option>
        <option value="カット" data-slots="2">カット（約60分）</option>
        <option value="カラー＋カット" data-slots="5">カラー＋カット（約150分）</option>
        <option value="パーマ＋カット" data-slots="5">パーマ＋カット（約150分）</option>
        <option value="トリートメント" data-slots="2">トリートメント（約40分）</option>
        <option value="縮毛矯正＋カット" data-slots="6">縮毛矯正＋カット（約180分）</option>
        <option value="まつ毛パーマ" data-slots="2">まつ毛パーマ（60分）</option>
        <option value="まつげエクステ" data-slots="3">まつげエクステ（90分）</option>
        <option value="着付け" data-slots="2">着付け（約60分）</option>
      </select>
      <small class="text-muted" style="font-size: 0.75rem;">※メニューを選ぶと空き状況が表示されます</small>
    </div>

    <div class="form-group" id="calendarGroup" style="display:none;">
      <label>日時を選択<span class="required-badge">必須</span></label>
      
      <div class="week-nav">
        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="prevWeek()">&lt; 前の週</button>
        <span class="current-month" id="currentMonthLabel"></span>
        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="nextWeek()">次の週 &gt;</button>
      </div>

      <div class="table-responsive">
        <table class="calendar-table">
          <thead>
            <tr id="dateHeader">
              </tr>
          </thead>
          <tbody id="timeBody">
            </tbody>
        </table>
      </div>
      <div class="text-center mt-2" id="loadingMsg" style="display:none; color:#007bff; font-size:0.9rem;">
        読み込み中...
      </div>
    </div>

    <input type="hidden" name="date" id="selectedDate">
    <input type="hidden" name="time" id="selectedTime">
    
    <div class="form-group">
      <label>お問い合わせ</label>
      <textarea name="inquiry" class="form-control" rows="3" placeholder="ご要望など"></textarea>
    </div>

    <button type="button" id="submitBtn" class="btn btn-success btn-block" onclick="submitData()" disabled>予約を確定する</button>
  </form>
</div>

<div class="container" id="success-area">
  <div class="success-icon">✔</div>
  <h5>予約を受け付けました</h5>
  <p>ご予約ありがとうございます。<br>確認後、LINEにてご連絡いたします。</p>
  <button onclick="closeLiff()" class="btn btn-secondary mt-4">閉じる</button>
</div>

<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<script>
  // ★★★ ここにGASのURL（/execで終わるやつ）を貼ってください ★★★
  const GAS_API_URL = "https://script.google.com/macros/s/AKfycby7T82gguG2KXD37D0Se-JN7ZgzhW2Rp51bpnQggd8bM41im4VHDDZIgPXxxDUSYg45RA/exec";
  const MY_LIFF_ID = "1657883881-JG16djMv";

  let bookedTimesAll = [];
  let currentBaseDate = new Date(); // 表示中の週の基準日

  window.onload = function() {
    // LIFF初期化
    if(typeof liff !== 'undefined'){
      liff.init({ liffId: MY_LIFF_ID }).then(() => {
        if (!liff.isLoggedIn()) liff.login();
      }).catch(err => console.log(err));
    }
    // データ取得開始
    fetchBookedData();
  };

  function fetchBookedData() {
    document.getElementById('loadingMsg').style.display = 'block';
    fetch(GAS_API_URL + '?p=json')
      .then(res => res.json())
      .then(data => {
        bookedTimesAll = data;
        document.getElementById('loadingMsg').style.display = 'none';
        // データが取れたらカレンダーを表示（メニューが選ばれていれば）
        renderWeekCalendar();
      })
      .catch(err => {
        console.error("通信エラー", err);
        document.getElementById('loadingMsg').innerText = "通信エラー";
      });
  }

  // 1週間のカレンダーを描画する心臓部
  function renderWeekCalendar() {
    const menuSelect = document.getElementById('menuInput');
    const slots = parseInt(menuSelect.options[menuSelect.selectedIndex].getAttribute('data-slots') || 0);

    // メニュー未選択ならカレンダーを出さない
    if (slots === 0) {
      document.getElementById('calendarGroup').style.display = 'none';
      return;
    }
    document.getElementById('calendarGroup').style.display = 'block';

    const headerRow = document.getElementById('dateHeader');
    const timeBody = document.getElementById('timeBody');
    headerRow.innerHTML = '<th style="width: 50px; background:#eee;">時間</th>'; // 左上の空セル
    timeBody.innerHTML = '';

    // 今週の日曜日にセット
    let tempDate = new Date(currentBaseDate);
    tempDate.setDate(tempDate.getDate() - tempDate.getDay()); // 日曜日に戻す

    const days = ['日', '月', '火', '水', '木', '金', '土'];
    let weekDates = [];

    // ヘッダー（日付）を作る
    for (let i = 0; i < 7; i++) {
      let m = tempDate.getMonth() + 1;
      let d = tempDate.getDate();
      let w = tempDate.getDay();
      
      let thClass = '';
      if (w === 0) thClass = 'th-sun';
      if (w === 6) thClass = 'th-sat';

      let yyyy = tempDate.getFullYear();
      let mm = ("0" + m).slice(-2);
      let dd = ("0" + d).slice(-2);
      let dateStr = `${yyyy}/${mm}/${dd}`; // 2026/02/01

      // 定休日判定（月曜 or 第3火曜）
      let isHoliday = false;
      if (w === 1) isHoliday = true; // 毎週月曜
      if (w === 2 && d >= 15 && d <= 21) isHoliday = true; // 第3火曜

      weekDates.push({ dateStr: dateStr, isHoliday: isHoliday });

      // ヘッダーHTML追加
      let thHtml = `<th class="${thClass}">${d}<br><small>(${days[w]})</small></th>`;
      headerRow.insertAdjacentHTML('beforeend', thHtml);

      // 月の表示を更新（最初の日の月を表示）
      if (i === 0) {
        document.getElementById('currentMonthLabel').innerText = `${yyyy}年 ${m}月`;
      }

      tempDate.setDate(tempDate.getDate() + 1); // 翌日へ
    }

    // 時間枠（行）を作る (9:00 - 18:00)
    for (let h = 9; h <= 18; h++) { // 19時までやるなら h<=18 にしてループ内で考慮
       let timeStr = h + ":00";
       let tr = document.createElement('tr');
       
       // 左端の時間セル
       tr.innerHTML = `<td style="font-weight:bold; font-size:0.8rem; background:#fcfcfc;">${timeStr}</td>`;

       // 7日分ループ
       for (let i = 0; i < 7; i++) {
         let info = weekDates[i];
         let td = document.createElement('td');
         
         // 過去の日時かチェック
         let targetDateTime = new Date(info.dateStr + ' ' + timeStr);
         let now = new Date();

         if (info.isHoliday) {
           // 定休日
           td.innerHTML = '<span class="symbol-rest">休</span>';
           td.style.backgroundColor = '#fff5f5';
         } else if (targetDateTime < now) {
           // 過去
           td.innerHTML = '<span class="symbol-ng">-</span>';
           td.style.backgroundColor = '#fafafa';
         } else {
           // 空き状況チェック（ここがスマート予約！）
           if (isAvailable(info.dateStr, h, 0, slots)) {
             td.innerHTML = '<span class="symbol-ok">◎</span>';
             td.onclick = function() { selectSlot(this, info.dateStr, timeStr); };
           } else {
             td.innerHTML = '<span class="symbol-ng">×</span>';
           }
         }
         tr.appendChild(td);
       }
       timeBody.appendChild(tr);
    }
  }

  // 指定した日時から slots 分連続で空いているかチェック
  function isAvailable(dateStr, startH, startM, neededSlots) {
    let currentH = startH;
    let currentM = startM;

    // その日の予約リストを抽出
    let bookedToday = bookedTimesAll
        .filter(dt => dt.startsWith(dateStr))
        .map(dt => dt.split(' ')[1]); // ["10:00", "13:00"]

    for (let i = 0; i < neededSlots; i++) {
      let timeStr = currentH + ":" + (currentM === 0 ? "00" : "30");

      // 1. すでに予約が入っているか？
      if (bookedToday.indexOf(timeStr) !== -1) return false;
      
      // 2. 閉店時間(19:00)を超えるか？
      if (currentH >= 19) return false;

      // 30分進める
      currentM += 30;
      if (currentM >= 60) {
        currentM = 0;
        currentH++;
      }
    }
    return true;
  }

  // ○を押したときの処理
  function selectSlot(td, date, time) {
    // 選択状態のクリア
    let selected = document.querySelector('.calendar-table td.selected');
    if (selected) selected.classList.remove('selected');
    
    // 選択
    td.classList.add('selected');

    // 隠しフォームにセット
    document.getElementById('selectedDate').value = date;
    document.getElementById('selectedTime').value = time;
    
    // ボタン有効化
    document.getElementById('submitBtn').disabled = false;
  }

  function prevWeek() {
    currentBaseDate.setDate(currentBaseDate.getDate() - 7);
    renderWeekCalendar();
  }
  function nextWeek() {
    currentBaseDate.setDate(currentBaseDate.getDate() + 7);
    renderWeekCalendar();
  }

  function submitData() {
    var form = document.getElementById('bookingForm');
    var menuSelect = document.getElementById('menuInput');
    var slots = menuSelect.options[menuSelect.selectedIndex].getAttribute('data-slots');
    
    var data = {
      date: document.getElementById('selectedDate').value,
      time: document.getElementById('selectedTime').value,
      name: form.name.value,
      menu: form.menu.value,
      inquiry: form.inquiry.value,
      slots: slots
    };

    if(!data.date || !data.time) { alert("日時を選択してください"); return; }

    var btn = document.getElementById('submitBtn');
    btn.disabled = true;
    btn.textContent = "送信中...";

    fetch(GAS_API_URL, {
      method: 'POST',
      headers: { "Content-Type": "text/plain" },
      body: JSON.stringify(data)
    })
    .then(res => res.text())
    .then(msg => {
      document.getElementById('booking-area').style.display = 'none';
      document.getElementById('success-area').style.display = 'block';
      window.scrollTo(0,0);
      if (liff && liff.isLoggedIn()) {
         var msgText = "Web予約完了\n" + data.date + " " + data.time + "\n" + data.menu;
         liff.sendMessages([{ 'type': 'text', 'text': msgText }]).catch(e => console.log(e));
      }
    })
    .catch(err => {
      alert("送信エラー: " + err);
      btn.disabled = false;
      btn.textContent = "予約を確定する";
    });
  }

  function closeLiff() { if (liff) liff.closeWindow(); }
</script>

</body>
</html>
